rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if user is admin
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
             (request.auth.token.email != null && exists(/databases/$(database)/documents/admin_emails/$(request.auth.token.email)));
    }
    
    // Helper function to check if user is eligible faculty (by email)
    function isEligible() {
       return request.auth.token.email != null && exists(/databases/$(database)/documents/eligibleFaculty/$(request.auth.token.email));
    }

    // Admins Collection (UID based): Read-only for auth, Write by Admin
    match /admins/{userId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Admin Emails Collection (Email based): Read-only for auth, Write by Admin
    match /admin_emails/{email} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Eligible Faculty Collection: Read-only for authenticated users (check status), Write by Admins. ID is Email.
    match /eligibleFaculty/{email} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Projects: Readable by any authenticated user, Writeable by Admin
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow write, delete: if isAdmin();
    }

    // Applications: Readable by Admin and the applicant. Create by any authenticated user.
    match /applications/{applicationId} {
      allow read: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
      allow update: if request.auth != null && isAdmin();
      allow delete: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
    }
  }
}
